/**
 \file
 \brief bliter模块测试
 \author Shenzhen Hisilicon Co., Ltd.
 \date 2008-2018
 \version draft
 \author s37678
 \date 2008-5-23
 */
#include <stdio.h>
#include <stdlib.h>
#include <assert.h>
#include "CUnit.h"
#include "hi_type.h"
#include "hi_go.h"
#include "higo_blit.h"
#include "higo_common.h"
#include "higo_surface.h"
#include "higo_handle.h"

static HI_HANDLE s_hTextSurface = INVALID_HANDLE;
static HI_HANDLE s_hLayerSurface = INVALID_HANDLE;
static HI_HANDLE s_hLayer = INVALID_HANDLE;

static HI_VOID test_CreateText_OnlySbc(HI_VOID)
{
    HI_S32 s32Ret;
    HI_HANDLE hFont = INVALID_HANDLE;
        
    s32Ret = HI_GO_CreateText("./res/higo_gb2312.bin", NULL, &hFont);
    CU_ASSERT_EQUAL(s32Ret, HI_SUCCESS);
    CU_ASSERT_NOT_EQUAL(hFont, INVALID_HANDLE);

    s32Ret = HI_GO_DestroyText(hFont);
    CU_ASSERT_EQUAL(s32Ret, HI_SUCCESS);
}

static HI_VOID test_CreateText_OnlyMbc(HI_VOID)
{
    HI_S32 s32Ret;
    HI_HANDLE hFont = INVALID_HANDLE;
        
    s32Ret = HI_GO_CreateText(NULL, "./res/higo_gb2312.bin", &hFont);
    CU_ASSERT_EQUAL(s32Ret, HI_SUCCESS);
    CU_ASSERT_NOT_EQUAL(hFont, INVALID_HANDLE);
    
    s32Ret = HI_GO_DestroyText(hFont);
    CU_ASSERT_EQUAL(s32Ret, HI_SUCCESS);
}

static HI_VOID test_CreateText_MbcAndSbc(HI_VOID)
{
    HI_S32 s32Ret;
    HI_HANDLE hFont = INVALID_HANDLE;
        
    s32Ret = HI_GO_CreateText(NULL, "./res/higo_gb2312.bin", &hFont);
    CU_ASSERT_EQUAL(s32Ret, HI_SUCCESS);
    CU_ASSERT_NOT_EQUAL(hFont, INVALID_HANDLE);
    
    s32Ret = HI_GO_DestroyText(hFont);
    CU_ASSERT_EQUAL(s32Ret, HI_SUCCESS);
}

static HI_VOID test_CreateText_Ttf(HI_VOID)
{
    HI_S32 s32Ret;
    HI_HANDLE hFont = INVALID_HANDLE;
        
    s32Ret = HI_GO_CreateText("./res/simhei.ttf", "./res/simhei.ttf", &hFont);
    CU_ASSERT_EQUAL(s32Ret, HI_SUCCESS);
    CU_ASSERT_NOT_EQUAL(hFont, INVALID_HANDLE);
    
    s32Ret = HI_GO_DestroyText(hFont);
    CU_ASSERT_EQUAL(s32Ret, HI_SUCCESS);
}

static HI_VOID test_Show()
{
    HI_GO_Blit(&s_hTextSurface, NULL, &s_hLayerSurface, NULL, NULL);
    HI_GO_RefreshLayer(s_hLayerSurface, NULL);
    getchar();
}

static HI_VOID test_CreateText_Ttf_24dot(HI_VOID)
{
    HI_S32 s32Ret;
    HIGO_TEXT_INFO_S info;
    HI_HANDLE hFont = INVALID_HANDLE;
    HI_RECT rc = {100, 100, 400, 400};

    info.pMbcFontFile = "./res/simhei.ttf";
    info.pSbcFontFile = "./res/simhei.ttf";
    info.u32Size = 24;
    s32Ret = HI_GO_CreateTextEx(&info, &hFont);
    CU_ASSERT_EQUAL(s32Ret, HI_SUCCESS);
    CU_ASSERT_NOT_EQUAL(hFont, INVALID_HANDLE);
    
    HI_GO_TextOut(hFont, s_hTextSurface, "24矢量字体", &rc);
    test_Show();

    s32Ret = HI_GO_DestroyText(hFont);
    CU_ASSERT_EQUAL(s32Ret, HI_SUCCESS);
}

static HI_VOID test_CreateText_Ttf_36dot(HI_VOID)
{
    HI_S32 s32Ret;
    HIGO_TEXT_INFO_S info;
    HI_HANDLE hFont = INVALID_HANDLE;
    HI_RECT rc = {100, 100, 400, 400};

    info.pMbcFontFile = "./res/simhei.ttf";
    info.pSbcFontFile = "./res/simhei.ttf";
    info.u32Size = 36;
    s32Ret = HI_GO_CreateTextEx(&info, &hFont);
    CU_ASSERT_EQUAL(s32Ret, HI_SUCCESS);
    CU_ASSERT_NOT_EQUAL(hFont, INVALID_HANDLE);

    HI_GO_TextOut(hFont, s_hLayerSurface, "36矢量字体", &rc);
    test_Show();

    s32Ret = HI_GO_DestroyText(hFont);
    CU_ASSERT_EQUAL(s32Ret, HI_SUCCESS);
}

static HI_VOID test_CreateText_Ttf_8dot(HI_VOID)
{
    HI_S32 s32Ret;
    HIGO_TEXT_INFO_S info;
    HI_HANDLE hFont = INVALID_HANDLE;
    HI_RECT rc = {100, 100, 400, 400};

    info.pMbcFontFile = "./res/simhei.ttf";
    info.pSbcFontFile = "./res/simhei.ttf";
    info.u32Size = 8;
    s32Ret = HI_GO_CreateTextEx(&info, &hFont);
    CU_ASSERT_EQUAL(s32Ret, HI_SUCCESS);
    CU_ASSERT_NOT_EQUAL(hFont, INVALID_HANDLE);

    HI_GO_TextOut(hFont, s_hLayerSurface, "8矢量字体", &rc);
    test_Show();
    
    s32Ret = HI_GO_DestroyText(hFont);
    CU_ASSERT_EQUAL(s32Ret, HI_SUCCESS);
}

static HI_VOID test_CreateText_SbcIsInvalidFontFile(HI_VOID)
{
    HI_S32 s32Ret;
    HIGO_TEXT_INFO_S info;
    HI_HANDLE hFont = INVALID_HANDLE;
    HI_RECT rc = {100, 100, 400, 400};

    info.pMbcFontFile = "./res/simhei.ttf";
    info.pSbcFontFile = "./res/error.bin";
    info.u32Size = 24;
    s32Ret = HI_GO_CreateTextEx(&info, &hFont);
    CU_ASSERT_EQUAL(s32Ret, HI_SUCCESS);
    CU_ASSERT_NOT_EQUAL(hFont, INVALID_HANDLE);

    HI_GO_TextOut(hFont, s_hLayerSurface, "24矢量字体", &rc);
    test_Show();
    
    s32Ret = HI_GO_DestroyText(hFont);
    CU_ASSERT_EQUAL(s32Ret, HI_SUCCESS);
}

static HI_VOID test_CreateText_MbcIsInvalidFontFile(HI_VOID)
{
    HI_S32 s32Ret;
    HIGO_TEXT_INFO_S info;
    HI_HANDLE hFont = INVALID_HANDLE;
    HI_RECT rc = {100, 100, 400, 400};

    info.pMbcFontFile = "./res/error.bin";
    info.pSbcFontFile = "./res/simhei.ttf";
    info.u32Size = 24;
    s32Ret = HI_GO_CreateTextEx(&info, &hFont);
    CU_ASSERT_EQUAL(s32Ret, HI_SUCCESS);
    CU_ASSERT_NOT_EQUAL(hFont, INVALID_HANDLE);

    HI_GO_TextOut(hFont, s_hLayerSurface, "24矢量字体", &rc);
    test_Show();
    
    s32Ret = HI_GO_DestroyText(hFont);
    CU_ASSERT_EQUAL(s32Ret, HI_SUCCESS);
}


static CU_TestInfo test_cases_LayerAndRefresh[] = {
    {"正常测试, 双buffer模式刷新", test_HI_GO_RefreshLayer001},
    {"正常测试, 三buffer模式刷新", test_HI_GO_RefreshLayer002},
    {"正常测试, 单buffers模式刷新",test_HI_GO_RefreshLayer003},
    CU_TEST_INFO_NULL
};

static HI_S32 test_RefreshLayer_init()
{
    HI_S32 s32Ret = HI_FAILURE;
    HIGO_LAYER_INFO_S stLayerInfo;
        
    s32Ret =  HI_GO_Init();
    if (HI_SUCCESS != s32Ret)
    {
        printf("failed to int higo\n");

    }

    s32Ret = HI_GO_CreateLayer(&stLayerInfo, &s_hLayer);
    if (HI_SUCCESS != s32Ret)
    {
        printf("failed to create layer!\n");
        HI_GO_Deinit();
    }
    
    HI_GO_GetLayerSurface(s_hLayer, s_hLayerSurface);
    return s32Ret;
}

static HI_S32 test_RefreshLayer_deinit()
{
    HI_S32 s32Ret = HI_FAILURE;

    if (INVALID_HANDLE != s_hLayer)
    {
        HI_GO_DestroyLayer(s_hLayer);
    }
    
    s32Ret =  HI_GO_Deinit();
    if (HI_SUCCESS != s32Ret)
    {
        printf("failed to deint higo\n");
    }


    return s32Ret;
}

static CU_SuiteInfo suites[] = {
    {"测试图层和刷新",	test_RefreshLayer_init, test_RefreshLayer_deinit, test_cases_LayerAndRefresh},
    CU_SUITE_INFO_NULL
};

int AddTextTests()
{
    assert(NULL != CU_get_registry());
    assert(!CU_is_test_running());

    /* Register suites. */
    if (CU_register_suites(suites) != CUE_SUCCESS)
    {
        fprintf(stderr, "suite registration failed - %s\n",
                CU_get_error_msg());
        exit(EXIT_FAILURE);
    }

    return 0;
}
